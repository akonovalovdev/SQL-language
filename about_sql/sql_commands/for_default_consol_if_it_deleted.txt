--------------------DELETE-------------------------------
DELETE  FROM book; --таблица;

DELETE FROM supply
WHERE author IN(
    SELECT author
    FROM book
    GROUP BY author
    HAVING SUM(amount) >10
);

--------------------CREATE-------------------------------
-- Создать таблицу заказ (ordering), куда включить авторов и названия тех книг,
-- количество экземпляров которых в таблице book меньше 4. Для всех книг указать одинаковое количество экземпляров 5.
CREATE TABLE ordering AS
SELECT author, title, 5 AS amount
FROM book
WHERE amount < 4;

-- Создать таблицу заказ (ordering), куда включить авторов и названия тех книг,
-- количество экземпляров которых в таблице book меньше 4. Для всех книг указать
-- одинаковое значение - среднее количество экземпляров книг в таблице book.

CREATE TABLE ordering AS
SELECT author, title,
       (
           SELECT ROUND(AVG(amount))
           FROM book
       ) AS amount
FROM book
WHERE amount < 4;

SELECT * FROM ordering;

DROP TABLE ordering;

--------------------UPDATE-------------------------------
UPDATE book
SET price = 0.7 * price
WHERE price > 200;
SELECT * FROM book;


UPDATE book
SET amount = amount; -- buy,
    --buy = 0;


-------------------SELECTS-------------------------------
SELECT name_genre AS Имя
FROM genre;

SELECT * FROM book;

SELECT title, amount, price,
       ROUND(CASE WHEN amount < 4  THEN price*0.5 ELSE price*0.7 END, 2) AS sale
FROM book;

SELECT *,
       price * amount AS total
FROM book;

SELECT title, price
FROM book
WHERE price < 600;

SELECT
    author,
    title,
    ROUND(CASE
              WHEN author = 'Булгаков М.А.' THEN price * 1.10
              WHEN author = 'Есенин С.А.' THEN price * 1.05 ELSE price
              END ,2) AS new_price
FROM book;

SELECT author, title, price
FROM book
WHERE amount < 10;

SELECT title, author, price
FROM book
WHERE price > 600 AND author = 'Булгаков М.А.';

SELECT
    title,
    author,
    price,
    amount
FROM book
WHERE (price < 500 OR price > 600) AND price * amount >= 5000;


-- SELECT author, title,
--        ROUND(IF(author = "Булгаков М.А.", price * 1.10, IF(author = "Есенин С.А.", price * 1.05, price)),2)
--            AS new_price
-- FROM book;

DROP TABLE book;

CREATE TABLE book( -- supply (поставка)
    book_id SERIAL PRIMARY KEY,
    title VARCHAR(50),
    author VARCHAR(30),
    price DECIMAL(8,2),
    amount INT
);

CREATE TABLE book(
                     book_id SERIAL PRIMARY KEY,
                     title TEXT,
                     author TEXT,
                     price DECIMAL(8,2),
                     amount INT
);
INSERT INTO book (title, author, price, amount)
VALUES ('Мастер и Маргарита', 'Булгаков М.А.',	670.99,	3),
       ('Белая гвардия', 'Булгаков М.А.', 540.50, 5),
       ('Идиот', 'Достоевский Ф.М.', 460.00, 10),
       ('Братья Карамазовы', 'Достоевский Ф.М.', 799.01, 3),
       ('Стихотворения и поэмы',	'Есенин С.А.',	650.00,	15),
       ('', 'Иванов С.С.',	50.00,	10),
       ('Дети полуночи', 'Рушди Салман', 950.00, 5),
       ('Лирика', 'Гумилев Н.С.', 460.00, 10),
       ('Поэмы', 'Бехтерев С.С.', 460.00, 10),
       ('Капитанская дочка', 'Пушкин А.С.', 520.50, 7);

INSERT INTO supply (title, author, price, amount)
VALUES
    ('Лирика', 'Пастернак Б.Л.', 518.99, 2),
    ('Черный человек', 'Есенин С.А.', 570.20, 6),
    ('Белая гвардия', 'Булгаков М.А.', 540.50, 7),
    ('Идиот', 'Достоевский Ф.М.', 360.80, 3);

INSERT INTO book (title, author, price, amount)
SELECT title, author, price, amount
FROM supply;

SELECT * FROM supply;
SELECT * FROM book;

INSERT INTO book (title, author, price, amount)
SELECT title, author, price, amount
FROM supply
WHERE title NOT IN (
    SELECT title
    FROM book
);

-- INSERT INTO book (title, author, price, amount)
-- VALUES ('Капитанская дочка', 'Пушкин А.С.', 520.50, 7);
INSERT INTO book (title, author, price, amount)
VALUES ('Игрок', 'Достоевский Ф.М.', 480.50, 10),
       ('Черный человек','Есенин С.А.', Null, Null);

SELECT title, amount
FROM book
WHERE amount BETWEEN 5 AND 14;

SELECT
    ROUND(AVG(price), 2) AS Средняя_цена,
    ROUND(SUM(price*amount), 2) AS Стоимость
FROM book
WHERE amount BETWEEN 5 AND 14;

SELECT title, price
FROM book
WHERE author IN ('Булгаков М.А.', 'Достоевский Ф.М.');

SELECT
    title,
    author
FROM book
WHERE (price BETWEEN 540.50 AND 800) AND amount IN(2,3,5,7);

SELECT title, author, price
FROM book
ORDER BY title;

SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY author, amount DESC;

SELECT
    author,
    title
FROM book
WHERE amount BETWEEN 2 AND 14
ORDER BY author DESC, title;

SELECT author,
       MIN(price) AS Минимальная_цена,
       MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000
ORDER BY Минимальная_цена DESC;

SELECT title
FROM book
WHERE title LIKE 'Б%';
/* эквивалентное условие
title LIKE 'б%'
*/

SELECT
    title,
    author
FROM book
WHERE title LIKE '_% _%' AND(author LIKE '%С.%' OR author LIKE '%С.')
ORDER BY title;

SELECT DISTINCT amount
FROM book;

SELECT author, MIN(price) AS min_price,  count(*), MAX(price) AS max_price, AVG(price) AS СРЕДНЕЕ
FROM book
GROUP BY author;

SELECT author, sum(amount), count(amount), count(*)
FROM book
GROUP BY author;

SELECT author,
       MIN(price) AS Минимальная_цена,
       MAX(price) AS Максимальная_цена
FROM book
WHERE author <> 'Есенин С.А.'
GROUP BY author
HAVING SUM(amount) > 10;

SELECT
    author AS Автор,
        COUNT(title) AS Различных_книг,
        SUM(amount) AS Количество_экземпляров
FROM book
GROUP BY author;

SELECT SUM(amount) AS Количество,
       SUM(price * amount) AS Стоимость
FROM book;

SELECT
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена,
    ROUND(AVG(DISTINCT price),2) AS Средняя_цена
FROM book;
-- GROUP BY author;

SELECT
    author,
    SUM(price*amount) AS Стоимость
FROM book
WHERE title <> 'Идиот' AND title <> 'Белая гвардия'
GROUP BY author
HAVING SUM(price*amount) > 5000
ORDER BY Стоимость DESC;

SELECT title, author, price, amount
FROM book
WHERE price <> (
    SELECT MAX(price)
    FROM book
) AND price <> (
    SELECT MIN(price)
    FROM book
);

SELECT
    author,
    title,
    price
FROM book
WHERE price <= (
    SELECT AVG(price)
    FROM book
) ORDER BY price DESC;

SELECT title, author, amount
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) >3;

SELECT
    author,
    title,
    price
FROM book
WHERE price - (SELECT MIN(price) FROM book) <=150
ORDER BY price;

SELECT title, author, amount, price
FROM book
WHERE author IN (
    SELECT author
    FROM book
    GROUP BY author
    HAVING SUM(amount) >= 12
);

SELECT
    author,
    title,
    amount
FROM book
WHERE amount IN(
    SELECT amount
    FROM book
    GROUP BY amount
    HAVING COUNT(amount) = 1
);

SELECT title, author, amount, price
FROM book
WHERE amount < ALL (
    SELECT AVG(amount)
    FROM book
    GROUP BY author
);

SELECT title, author, amount,
       (
           SELECT AVG(amount)
           FROM book
       ) AS Среднее_количество
FROM book
WHERE abs(amount - (SELECT AVG(amount) FROM book)) >3;